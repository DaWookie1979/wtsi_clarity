use strict;
use warnings;
use Test::More tests => 3;
use Test::Exception;
use Test::MockObject::Extends;
use Test::Warn;
use Carp;

use wtsi_clarity::epp::isc::pool_calculator;

use_ok('wtsi_clarity::epp::isc::pool_beckman_creator', 'can create beckman driver file for pooling');

local $ENV{'WTSI_CLARITY_HOME'}= q[t/data/config];

use wtsi_clarity::util::config;
my $config = wtsi_clarity::util::config->new();
my $base_uri = $config->clarity_api->{'base_uri'};

local $ENV{'WTSICLARITY_WEBCACHE_DIR'} = 't/data/epp/isc/pool_beckman';
local $ENV{'SAVE2WTSICLARITY_WEBCACHE'} = 0;

{
  my $expected_result = [
          'Sample, Name, Source EAN13, Source Barcode, Source Stock, Source Well, Destination EAN13, Destination Barcode, Destination Well, Source Volume',
          '1, PCRXP1, 1234567890123, DN367818, DN365894, A2, 1234567890124, DN369421, B1, 24.94',
          '2, PCRXP1, 1234567890123, DN367818, DN365894, A1, 1234567890124, DN369421, A1, 38.9'
        ];
  my $pooling_calculator_result = {
    'PCRXP1' => {
      'A1' => [
              {
                'Molarity' => '15',
                'source_plate' => '1234567890123',
                'Volume' => '38.9',
                'source_well' => 'A1'
              },
          ],
        'B1' => [
              {
                'Molarity' => '12',
                'source_plate' => '1234567890123',
                'Volume' => '24.94',
                'source_well' => 'A2'
              },
          ]
        },
      };
  my $mocked_beckman_creator = Test::MockObject::Extends->new( 
        wtsi_clarity::epp::isc::pool_beckman_creator->new(
          process_url => $base_uri . '/processes/122-22459')
      );

  $mocked_beckman_creator->mock(q(_get_result_from_pool_calculator), sub{
     return $pooling_calculator_result;
  });

  my $file_content = $mocked_beckman_creator->_beckman_file->content;

  is_deeply($file_content, $expected_result, 'get_file returns a file object with the correct content');
}

{
  my $expected_result = [
          'Sample, Name, Source EAN13, Source Barcode, Source Stock, Source Well, Destination EAN13, Destination Barcode, Destination Well, Source Volume',
          '1, PCRXP1, 1234567890123, DN367818, DN365894, C:2, 1234567890124, DN369421, B:1, 29.3264149094572',
          '2, PCRXP1, 1234567890123, DN367818, DN365894, D:2, 1234567890124, DN369421, B:1, 34.7123924543075',
          '3, PCRXP1, 1234567890123, DN367818, DN365894, A:2, 1234567890124, DN369421, B:1, 42.5524744647086',
          '4, PCRXP1, 1234567890123, DN367818, DN365894, B:2, 1234567890124, DN369421, B:1, 30.6878912474414',
          '5, PCRXP1, 1234567890123, DN367818, DN365894, G:2, 1234567890124, DN369421, B:1, 7.79543957867195',
          '6, PCRXP1, 1234567890123, DN367818, DN365894, H:2, 1234567890124, DN369421, B:1, 15.7809191636431',
          '7, PCRXP1, 1234567890123, DN367818, DN365894, E:2, 1234567890124, DN369421, B:1, 27.0227485619572',
          '8, PCRXP1, 1234567890123, DN367818, DN365894, F:2, 1234567890124, DN369421, B:1, 12.121719619813',
          '9, PCRXP1, 1234567890123, DN367818, DN365894, C:3, 1234567890124, DN369421, C:1, 13.6981006975386',
          '10, PCRXP1, 1234567890123, DN367818, DN365894, D:3, 1234567890124, DN369421, C:1, 34.743493985995',
          '11, PCRXP1, 1234567890123, DN367818, DN365894, A:3, 1234567890124, DN369421, C:1, 11.8195349985304',
          '12, PCRXP1, 1234567890123, DN367818, DN365894, B:3, 1234567890124, DN369421, C:1, 8.68351343540244',
          '13, PCRXP1, 1234567890123, DN367818, DN365894, G:3, 1234567890124, DN369421, C:1, 12.5739780476953',
          '14, PCRXP1, 1234567890123, DN367818, DN365894, H:3, 1234567890124, DN369421, C:1, 50',
          '15, PCRXP1, 1234567890123, DN367818, DN365894, E:3, 1234567890124, DN369421, C:1, 10.3351681493506',
          '16, PCRXP1, 1234567890123, DN367818, DN365894, F:3, 1234567890124, DN369421, C:1, 23.7920495399388',
          '17, PCRXP1, 1234567890123, DN367818, DN365894, H:9, 1234567890124, DN369421, A:2, 0.0525766691104673',
          '18, PCRXP1, 1234567890123, DN367818, DN365894, G:9, 1234567890124, DN369421, A:2, 7.77626945813995',
          '19, PCRXP1, 1234567890123, DN367818, DN365894, F:9, 1234567890124, DN369421, A:2, 50',
          '20, PCRXP1, 1234567890123, DN367818, DN365894, E:9, 1234567890124, DN369421, A:2, 14.7249563931707',
          '21, PCRXP1, 1234567890123, DN367818, DN365894, D:9, 1234567890124, DN369421, A:2, 13.4390843578812',
          '22, PCRXP1, 1234567890123, DN367818, DN365894, C:9, 1234567890124, DN369421, A:2, 19.1099141659182',
          '23, PCRXP1, 1234567890123, DN367818, DN365894, B:9, 1234567890124, DN369421, A:2, 18.119170360122',
          '24, PCRXP1, 1234567890123, DN367818, DN365894, A:9, 1234567890124, DN369421, A:2, 20.1612330052492',
          '25, PCRXP1, 1234567890123, DN367818, DN365894, B:4, 1234567890124, DN369421, D:1, 28.9773210660811',
          '26, PCRXP1, 1234567890123, DN367818, DN365894, A:4, 1234567890124, DN369421, D:1, 34.4701429627152',
          '27, PCRXP1, 1234567890123, DN367818, DN365894, D:4, 1234567890124, DN369421, D:1, 31.8544468903791',
          '28, PCRXP1, 1234567890123, DN367818, DN365894, C:4, 1234567890124, DN369421, D:1, 22.3094966144123',
          '29, PCRXP1, 1234567890123, DN367818, DN365894, F:4, 1234567890124, DN369421, D:1, 16.4176715554529',
          '30, PCRXP1, 1234567890123, DN367818, DN365894, E:4, 1234567890124, DN369421, D:1, 43.3215548340441',
          '31, PCRXP1, 1234567890123, DN367818, DN365894, H:4, 1234567890124, DN369421, D:1, 10.081237320413',
          '32, PCRXP1, 1234567890123, DN367818, DN365894, G:4, 1234567890124, DN369421, D:1, 12.5681287565023',
          '33, PCRXP1, 1234567890123, DN367818, DN365894, A:7, 1234567890124, DN369421, G:1, 15.090637735737',
          '34, PCRXP1, 1234567890123, DN367818, DN365894, B:7, 1234567890124, DN369421, G:1, 30.5206913225476',
          '35, PCRXP1, 1234567890123, DN367818, DN365894, C:7, 1234567890124, DN369421, G:1, 19.6856728132602',
          '36, PCRXP1, 1234567890123, DN367818, DN365894, D:7, 1234567890124, DN369421, G:1, 18.8237913549673',
          '37, PCRXP1, 1234567890123, DN367818, DN365894, E:7, 1234567890124, DN369421, G:1, 20.4839499759824',
          '38, PCRXP1, 1234567890123, DN367818, DN365894, F:7, 1234567890124, DN369421, G:1, 17.0884712474118',
          '39, PCRXP1, 1234567890123, DN367818, DN365894, G:7, 1234567890124, DN369421, G:1, 42.1180264028625',
          '40, PCRXP1, 1234567890123, DN367818, DN365894, H:7, 1234567890124, DN369421, G:1, 36.1887591472311',
          '41, PCRXP1, 1234567890123, DN367818, DN365894, D:1, 1234567890124, DN369421, A:1, 10.3788300655803',
          '42, PCRXP1, 1234567890123, DN367818, DN365894, C:1, 1234567890124, DN369421, A:1, 42.0815083475065',
          '43, PCRXP1, 1234567890123, DN367818, DN365894, B:1, 1234567890124, DN369421, A:1, 30.4546860247276',
          '44, PCRXP1, 1234567890123, DN367818, DN365894, A:1, 1234567890124, DN369421, A:1, 34.9584928858189',
          '45, PCRXP1, 1234567890123, DN367818, DN365894, H:1, 1234567890124, DN369421, A:1, 17.0310083604866',
          '46, PCRXP1, 1234567890123, DN367818, DN365894, G:1, 1234567890124, DN369421, A:1, 12.3577793690254',
          '47, PCRXP1, 1234567890123, DN367818, DN365894, F:1, 1234567890124, DN369421, A:1, 8.99859642970516',
          '48, PCRXP1, 1234567890123, DN367818, DN365894, E:1, 1234567890124, DN369421, A:1, 43.7390985171495',
          '49, PCRXP1, 1234567890123, DN367818, DN365894, A:6, 1234567890124, DN369421, F:1, 29.5348599265865',
          '50, PCRXP1, 1234567890123, DN367818, DN365894, B:6, 1234567890124, DN369421, F:1, 19.5754271139585',
          '51, PCRXP1, 1234567890123, DN367818, DN365894, C:6, 1234567890124, DN369421, F:1, 12.6901723343726',
          '52, PCRXP1, 1234567890123, DN367818, DN365894, D:6, 1234567890124, DN369421, F:1, 33.3290488726523',
          '53, PCRXP1, 1234567890123, DN367818, DN365894, E:6, 1234567890124, DN369421, F:1, 42.5933713857127',
          '54, PCRXP1, 1234567890123, DN367818, DN365894, F:6, 1234567890124, DN369421, F:1, 16.3421816539732',
          '55, PCRXP1, 1234567890123, DN367818, DN365894, G:6, 1234567890124, DN369421, F:1, 19.8964330916553',
          '56, PCRXP1, 1234567890123, DN367818, DN365894, H:6, 1234567890124, DN369421, F:1, 26.0385056210889',
          '57, PCRXP1, 1234567890123, DN367818, DN365894, H:8, 1234567890124, DN369421, H:1, 0',
          '58, PCRXP1, 1234567890123, DN367818, DN365894, G:8, 1234567890124, DN369421, H:1, 50',
          '59, PCRXP1, 1234567890123, DN367818, DN365894, F:8, 1234567890124, DN369421, H:1, 42.7844645447879',
          '60, PCRXP1, 1234567890123, DN367818, DN365894, E:8, 1234567890124, DN369421, H:1, 0.115495069043678',
          '61, PCRXP1, 1234567890123, DN367818, DN365894, D:8, 1234567890124, DN369421, H:1, 0.124868171350739',
          '62, PCRXP1, 1234567890123, DN367818, DN365894, C:8, 1234567890124, DN369421, H:1, 0.0915142653912199',
          '63, PCRXP1, 1234567890123, DN367818, DN365894, B:8, 1234567890124, DN369421, H:1, 0.269988330452036',
          '64, PCRXP1, 1234567890123, DN367818, DN365894, A:8, 1234567890124, DN369421, H:1, 0.276498816711976',
          '65, PCRXP1, 1234567890123, DN367818, DN365894, G:11, 1234567890124, DN369421, C:2, 12.1582253373418',
          '66, PCRXP1, 1234567890123, DN367818, DN365894, H:11, 1234567890124, DN369421, C:2, 16.4278206845083',
          '67, PCRXP1, 1234567890123, DN367818, DN365894, E:11, 1234567890124, DN369421, C:2, 8.1475236659963',
          '68, PCRXP1, 1234567890123, DN367818, DN365894, F:11, 1234567890124, DN369421, C:2, 34.1809735967797',
          '69, PCRXP1, 1234567890123, DN367818, DN365894, C:11, 1234567890124, DN369421, C:2, 15.050929522443',
          '70, PCRXP1, 1234567890123, DN367818, DN365894, D:11, 1234567890124, DN369421, C:2, 50',
          '71, PCRXP1, 1234567890123, DN367818, DN365894, A:11, 1234567890124, DN369421, C:2, 0',
          '72, PCRXP1, 1234567890123, DN367818, DN365894, B:11, 1234567890124, DN369421, C:2, 16.8078462369244',
          '73, PCRXP1, 1234567890123, DN367818, DN365894, B:5, 1234567890124, DN369421, E:1, 20.403039738909',
          '74, PCRXP1, 1234567890123, DN367818, DN365894, A:5, 1234567890124, DN369421, E:1, 20.571408568559',
          '75, PCRXP1, 1234567890123, DN367818, DN365894, D:5, 1234567890124, DN369421, E:1, 38.5093687229366',
          '76, PCRXP1, 1234567890123, DN367818, DN365894, C:5, 1234567890124, DN369421, E:1, 21.8194259158194',
          '77, PCRXP1, 1234567890123, DN367818, DN365894, F:5, 1234567890124, DN369421, E:1, 13.6245128772347',
          '78, PCRXP1, 1234567890123, DN367818, DN365894, E:5, 1234567890124, DN369421, E:1, 27.3506112044632',
          '79, PCRXP1, 1234567890123, DN367818, DN365894, H:5, 1234567890124, DN369421, E:1, 22.4425459719907',
          '80, PCRXP1, 1234567890123, DN367818, DN365894, G:5, 1234567890124, DN369421, E:1, 35.2790870000873',
          '81, PCRXP1, 1234567890123, DN367818, DN365894, F:12, 1234567890124, DN369421, D:2, 8.75391823483798',
          '82, PCRXP1, 1234567890123, DN367818, DN365894, E:12, 1234567890124, DN369421, D:2, 50',
          '83, PCRXP1, 1234567890123, DN367818, DN365894, H:12, 1234567890124, DN369421, D:2, 41.5400975169475',
          '84, PCRXP1, 1234567890123, DN367818, DN365894, G:12, 1234567890124, DN369421, D:2, 7.388702658313',
          '85, PCRXP1, 1234567890123, DN367818, DN365894, B:12, 1234567890124, DN369421, D:2, 15.8213766119961',
          '86, PCRXP1, 1234567890123, DN367818, DN365894, A:12, 1234567890124, DN369421, D:2, 20.5445271022128',
          '87, PCRXP1, 1234567890123, DN367818, DN365894, D:12, 1234567890124, DN369421, D:2, 7.36409369094583',
          '88, PCRXP1, 1234567890123, DN367818, DN365894, C:12, 1234567890124, DN369421, D:2, 12.4390717986536',
          '89, PCRXP1, 1234567890123, DN367818, DN365894, G:10, 1234567890124, DN369421, B:2, 6.42079350900945',
          '90, PCRXP1, 1234567890123, DN367818, DN365894, H:10, 1234567890124, DN369421, B:2, 7.46629969355038',
          '91, PCRXP1, 1234567890123, DN367818, DN365894, E:10, 1234567890124, DN369421, B:2, 15.7881679575889',
          '92, PCRXP1, 1234567890123, DN367818, DN365894, F:10, 1234567890124, DN369421, B:2, 0',
          '93, PCRXP1, 1234567890123, DN367818, DN365894, C:10, 1234567890124, DN369421, B:2, 27.4143396154836',
          '94, PCRXP1, 1234567890123, DN367818, DN365894, D:10, 1234567890124, DN369421, B:2, 8.04737870768341',
          '95, PCRXP1, 1234567890123, DN367818, DN365894, A:10, 1234567890124, DN369421, B:2, 11.5300820671408',
          '96, PCRXP1, 1234567890123, DN367818, DN365894, B:10, 1234567890124, DN369421, B:2, 50'
        ];

  my $beckman_creator = wtsi_clarity::epp::isc::pool_beckman_creator->new(
          process_url => $base_uri . '/processes/122-22459');
  my $file_content = $beckman_creator->_beckman_file->content;

  is_deeply($file_content, $expected_result, 'get_file returns a file object with the correct content');
}

1;
