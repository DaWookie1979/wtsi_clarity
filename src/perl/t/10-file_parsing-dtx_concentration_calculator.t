use strict;
use warnings;
use Test::More tests => 7;
use Test::Exception;
use Test::Warn;
use Carp;
use Data::Dumper;
use Readonly;

use_ok('wtsi_clarity::file_parsing::dtx_concentration_calculator', 'can use dtx_concentration_calculator');

## no critic(ValuesAndExpressions::RequireInterpolationOfMetachars)
Readonly::Scalar my $testdata_path => q(./t/data/file_parsing/dtx_concentration_calculator/);
Readonly::Scalar my $standard_name => q(1220344030849_ Pico-green assay run_AllRawData_06-06-2014_10.01.02.52.xml);
# Readonly::Scalar my $standard_name => q(truc.xml);
Readonly::Scalar my $plateA_name => q(1220344030849-4330332423663_ Pico-green assay run_AllRawData_06-06-2014_10.32.21.68.xml);
Readonly::Scalar my $plateB_name => q(1220344030849-4340332423730_ Pico-green assay run_AllRawData_06-06-2014_10.36.14.34.xml);
## use critic

my $EXPECTED_DATA_1 = {
  'standard' => [ 17382,
                  20659.25,
                  17912,
                  17633.25,
                  20045.75,
                  17239.75,
                  18291,
                  122006.25,
                  1052447.5,
                  1108190.75,
                  1123593.25,
                  1075696.5,
                  16198,
                  17604,
                  14984,
                  21127.25,
                  17301.75,
                  18078.25,
                  19107.75,
                  124728,
                  515333.75,
                  538822.75,
                  551347.25,
                  541453.25,
                  16525.25,
                  18522.75,
                  18398.25,
                  16082.75,
                  15316,
                  17830.5,
                  15915,
                  117062.5,
                  272018.75,
                  272230.25,
                  270256.25,
                  272066.25,
                  15015.25,
                  16907,
                  17772,
                  16977.5,
                  16546.25,
                  17406,
                  17550.5,
                  119886.75,
                  136556.5,
                  134623,
                  141901,
                  141372.5,
                  16922.75,
                  13880,
                  17141.75,
                  19930,
                  19317.25,
                  14789.75,
                  19275.75,
                  118374.5,
                  82088.25,
                  80449,
                  76432.25,
                  80660.5,
                  14333.25,
                  17262.25,
                  18261.75,
                  13847.5,
                  19000.5,
                  16460.25,
                  15476,
                  119449.25,
                  51110.5,
                  50230.75,
                  47440.5,
                  48227.5,
                  17465.75,
                  14540.75,
                  16238.25,
                  16240.5,
                  16129.5,
                  16730.75,
                  13030.25,
                  121803,
                  34738.5,
                  33814,
                  35460.75,
                  35908.25,
                  18703.75,
                  16756,
                  14930.25,
                  17115,
                  17878,
                  16665,
                  13873.75,
                  117552.5,
                  28100.5,
                  26997,
                  25164,
                  28076.5, ],
  'plateA' => [     17382,
                    20659.25,
                    17912,
                    17633.25,
                    20045.75,
                    17239.75,
                    18291,
                    122006.25,
                    1052447.5,
                    1108190.75,
                    1123593.25,
                    1075696.5,
                    16198,
                    17604,
                    14984,
                    21127.25,
                    17301.75,
                    18078.25,
                    19107.75,
                    124728,
                    515333.75,
                    538822.75,
                    551347.25,
                    541453.25,
                    16525.25,
                    18522.75,
                    18398.25,
                    16082.75,
                    15316,
                    17830.5,
                    15915,
                    117062.5,
                    272018.75,
                    272230.25,
                    270256.25,
                    272066.25,
                    15015.25,
                    16907,
                    17772,
                    16977.5,
                    16546.25,
                    17406,
                    17550.5,
                    119886.75,
                    136556.5,
                    134623,
                    141901,
                    141372.5,
                    16922.75,
                    13880,
                    17141.75,
                    19930,
                    19317.25,
                    14789.75,
                    19275.75,
                    118374.5,
                    82088.25,
                    80449,
                    76432.25,
                    80660.5,
                    14333.25,
                    17262.25,
                    18261.75,
                    13847.5,
                    19000.5,
                    16460.25,
                    15476,
                    119449.25,
                    51110.5,
                    50230.75,
                    47440.5,
                    48227.5,
                    17465.75,
                    14540.75,
                    16238.25,
                    16240.5,
                    16129.5,
                    16730.75,
                    13030.25,
                    121803,
                    34738.5,
                    33814,
                    35460.75,
                    35908.25,
                    18703.75,
                    16756,
                    14930.25,
                    17115,
                    17878,
                    16665,
                    13873.75,
                    117552.5,
                    28100.5,
                    26997,
                    25164,
                    28076.5, ],
  'plateB' => [     17382,
                    20659.25,
                    17912,
                    17633.25,
                    20045.75,
                    17239.75,
                    18291,
                    122006.25,
                    1052447.5,
                    1108190.75,
                    1123593.25,
                    1075696.5,
                    16198,
                    17604,
                    14984,
                    21127.25,
                    17301.75,
                    18078.25,
                    19107.75,
                    124728,
                    515333.75,
                    538822.75,
                    551347.25,
                    541453.25,
                    16525.25,
                    18522.75,
                    18398.25,
                    16082.75,
                    15316,
                    17830.5,
                    15915,
                    117062.5,
                    272018.75,
                    272230.25,
                    270256.25,
                    272066.25,
                    15015.25,
                    16907,
                    17772,
                    16977.5,
                    16546.25,
                    17406,
                    17550.5,
                    119886.75,
                    136556.5,
                    134623,
                    141901,
                    141372.5,
                    16922.75,
                    13880,
                    17141.75,
                    19930,
                    19317.25,
                    14789.75,
                    19275.75,
                    118374.5,
                    82088.25,
                    80449,
                    76432.25,
                    80660.5,
                    14333.25,
                    17262.25,
                    18261.75,
                    13847.5,
                    19000.5,
                    16460.25,
                    15476,
                    119449.25,
                    51110.5,
                    50230.75,
                    47440.5,
                    48227.5,
                    17465.75,
                    14540.75,
                    16238.25,
                    16240.5,
                    16129.5,
                    16730.75,
                    13030.25,
                    121803,
                    34738.5,
                    33814,
                    35460.75,
                    35908.25,
                    18703.75,
                    16756,
                    14930.25,
                    17115,
                    17878,
                    16665,
                    13873.75,
                    117552.5,
                    28100.5,
                    26997,
                    25164,
                    28076.5, ],
  'concentration' => [  -0.64,
        -1.22,
        -1.06,
        -1.81,
        -0.87,
        -2.14,
        -0.60,
        0.01,
        0.98,
        -0.53,
        -0.08,
        -0.87,
        -2.37,
        -0.70,
        -2.04,
        -0.95,
        -0.38,
        -1.82,
        -0.14,
        -0.45,
        -0.76,
        -0.21,
        -1.20,
        -1.85,
        -0.52,
        1.21,
        -1.28,
        -0.84,
        0.62,
        -2.38,
        -1.20,
        -0.77,
        0.67,
        -0.68,
        -1.66,
        -1.05,
        0.31,
        0.16,
        -1.26,
        -0.40,
        -0.71,
        -0.30,
        -0.42,
        -0.63,
        -1.92,
        -1.10,
        -0.96,
        -0.99,
        -0.19,
        0.21,
        -1.36,
        -0.56,
        0.29,
        -1.58,
        -2.79,
        -2.37,
        50.98,
        52.33,
        48.54,
        49.94,
        49.19,
        49.72,
        50.88,
        48.79,
        510.09,
        245.06,
        125.00,
        58.16,
        31.29,
        16.00,
        7.92,
        4.65,
        537.59,
        256.65,
        125.11,
        57.21,
        30.48,
        15.57,
        7.47,
        4.10,
        545.19,
        262.83,
        124.13,
        60.80,
        28.50,
        14.19,
        8.28,
        3.20,
        521.56,
        257.95,
        125.03,
        60.54,
        30.58,
        14.58,
        8.50,
        4.64,
        ] ,
  'cv%'    => [ 0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,],
};
my $TEST_DATA_2 = {
  'standard' => {
    'A:1' => 17382,
    'A:2' => 20659.25,
    'A:3' => 17912,
    'A:4' => 17633.25,
    'A:5' => 20045.75,
    'A:6' => 17239.75,
    'A:7' => 18291,
    'A:8' => 122006.25,
    'A:9' => 1052447.5,
    'A:10' => 1108190.75,
    'A:11' => 1123593.25,
    'A:12' => 1075696.5,
    'B:1' => 16198,
    'B:2' => 17604,
    'B:3' => 14984,
    'B:4' => 21127.25,
    'B:5' => 17301.75,
    'B:6' => 18078.25,
    'B:7' => 19107.75,
    'B:8' => 124728,
    'B:9' => 515333.75,
    'B:10' => 538822.75,
    'B:11' => 551347.25,
    'B:12' => 541453.25,
    'C:1' => 16525.25,
    'C:2' => 18522.75,
    'C:3' => 18398.25,
    'C:4' => 16082.75,
    'C:5' => 15316,
    'C:6' => 17830.5,
    'C:7' => 15915,
    'C:8' => 117062.5,
    'C:9' => 272018.75,
    'C:10' => 272230.25,
    'C:11' => 270256.25,
    'C:12' => 272066.25,
    'D:1' => 15015.25,
    'D:2' => 16907,
    'D:3' => 17772,
    'D:4' => 16977.5,
    'D:5' => 16546.25,
    'D:6' => 17406,
    'D:7' => 17550.5,
    'D:8' => 119886.75,
    'D:9' => 136556.5,
    'D:10' => 134623,
    'D:11' => 141901,
    'D:12' => 141372.5,
    'E:1' => 16922.75,
    'E:2' => 13880,
    'E:3' => 17141.75,
    'E:4' => 19930,
    'E:5' => 19317.25,
    'E:6' => 14789.75,
    'E:7' => 19275.75,
    'E:8' => 118374.5,
    'E:9' => 82088.25,
    'E:10' => 80449,
    'E:11' => 76432.25,
    'E:12' => 80660.5,
    'F:1'=> 14333.25,
    'F:2'=> 17262.25,
    'F:3'=> 18261.75,
    'F:4'=> 13847.5,
    'F:5'=> 19000.5,
    'F:6'=> 16460.25,
    'F:7'=> 15476,
    'F:8'=> 119449.25,
    'F:9'=> 51110.5,
    'F:10' => 50230.75,
    'F:11' => 47440.5,
    'F:12' => 48227.5,
    'G:1' => 17465.75,
    'G:2' => 14540.75,
    'G:3' => 16238.25,
    'G:4' => 16240.5,
    'G:5' => 16129.5,
    'G:6' => 16730.75,
    'G:7' => 13030.25,
    'G:8' => 121803,
    'G:9' => 34738.5,
    'G:10' => 33814,
    'G:11' => 35460.75,
    'G:12' => 35908.25,
    'H:1' => 18703.75,
    'H:2' => 16756,
    'H:3' => 14930.25,
    'H:4' => 17115,
    'H:5' => 17878,
    'H:6' => 16665,
    'H:7' => 13873.75,
    'H:8' => 117552.5,
    'H:9' => 28100.5,
    'H:10' => 26997,
    'H:11' => 25164,
    'H:12' => 28076.5,
  },
};

my $EXPECTED_DATA_2 = {
  'std1' => 32011.4,
  'std2' => 15255.1,
  'std3' => 928.8,
  'std4' => 3585.9,
  'std5' => 2428.5,
  'std6' => 1707.2,
  'std7' => 914.8,
  'std8' => 1379.9,
  'average1' => 1089982,
  'average2' => 536739.25,
  'average3' => 271642.875,
  'average4' => 138613.25,
  'average5' => 79907.5,
  'average6' => 49252.3125,
  'average7' => 34980.375,
  'average8' => 27084.5,
  'cv1' => 2.9,
  'cv2' => 2.8,
  'cv3' => 0.3,
  'cv4' => 2.6,
  'cv5' => 3.0,
  'cv6' => 3.5,
  'cv7' => 2.6,
  'cv8' => 5.1,
  'known_concentration1' => 10,
  'known_concentration2' => 5,
  'known_concentration3' => 2.5,
  'known_concentration4' => 1.25,
  'known_concentration5' => 0.625,
  'known_concentration6' => 0.3125,
  'known_concentration7' => 0.15625,
  'known_concentration8' => 0.078125,
};

my $EXPECTED_DATA_3 = {
  'slope' => 101332.7912,
  'intercept' => 18679.62839,
};

{
  my $calculator = wtsi_clarity::file_parsing::dtx_concentration_calculator->new(
    standard_path => $testdata_path.$standard_name,
    plateA_path   => $testdata_path.$plateA_name,
    plateB_path   => $testdata_path.$plateB_name);

  isa_ok( $calculator, 'wtsi_clarity::file_parsing::dtx_concentration_calculator');

  my $standard_fluorescences = $calculator->cvs();
  # print Dumper $standard_fluorescences;
  # my $plateA_fluorescences = $calculator->plateA_fluorescence;
  # my $plateB_fluorescences = $calculator->plateB_fluorescence;

  # cmp_ok( scalar @{$standard_fluorescences}, 'eq', 96, "standard_fluorescence should have the correct length.");


  # while (my ($well, $res) = each %{$results} ) {
  #   my $expected = $EXPECTED_DATA_1->{$well};
  #   my $conc = $res->{'standard'};
  #   cmp_ok($conc, 'eq', $expected, "getConcentration(...) should give the correct concentrations.");
  # }
}

{ #get_standard_intermediate_coefficients
  my $res = wtsi_clarity::file_parsing::dtx_concentration_calculator::get_standard_intermediate_coefficients($TEST_DATA_2);


  while (my ($well, $exp) = each %{$EXPECTED_DATA_2} ) {
    my $expected = $EXPECTED_DATA_2->{$well};
    # print "$well ==> ".$res->{$well} ." -- $expected \n";
    cmp_ok(abs($res->{$well} - $expected), '<', 0.1 , "get_standard_intermediate_coefficients( $well ) should give the correct concentrations.");
  }
}

{ #get_standard_coefficients
  my $res = wtsi_clarity::file_parsing::dtx_concentration_calculator::get_standard_coefficients($TEST_DATA_2);


  while (my ($well, $exp) = each %{$EXPECTED_DATA_3} ) {
    my $expected = $EXPECTED_DATA_3->{$well};
    cmp_ok(abs($res->{$well} - $expected), '<', 0.1 , "get_standard_coefficients( $well ) should give the correct concentrations.");
  }
}

{ #get_concentrations
my $calculator = wtsi_clarity::file_parsing::dtx_concentration_calculator->new(
    standard_path => $testdata_path.$standard_name,
    plateA_path   => $testdata_path.$plateA_name,
    plateB_path   => $testdata_path.$plateB_name);

  isa_ok( $calculator, 'wtsi_clarity::file_parsing::dtx_concentration_calculator');

  my $res = $calculator->get_concentrations();
  print Dumper $res;
  # while (my ($well, $exp) = each %{$EXPECTED_DATA_3} ) {
  #   my $expected = $EXPECTED_DATA_3->{$well};
  #   cmp_ok(abs($res->{$well} - $expected), '<', 0.1 , "get_concentrations( $well ) should give the correct concentrations.");
  # }
}

1;
